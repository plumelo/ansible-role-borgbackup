---

- name: Install borgmatic
  pip:
    name: borgmatic
    virtualenv: '{{ borg_virtual_env }}'
    virtualenv_command: virtualenv
    virtualenv_python: python3
  become: true
  become_user: '{{ borg_user }}'

- name: Ensure borgmatic config directory exists
  file:
    path: '{{ borgmatic_config_dir }}'
    state: directory
  become: true
  become_user: '{{ borg_user }}'

- name: Create borgmatic config file
  template:
    src: app.yaml.j2
    dest: '{{ borgmatic_config_dir }}/app_{{ item.name }}.yaml'
  with_items:
    - '{{ borgmatic_configs }}'
  become: true
  become_user: '{{ borg_user }}'

- name: Cron job
  cron:
    name: '{{ item.name }}'
    user: '{{ borg_user }}'
    minute: '*'
    # yamllint disable-line rule:line-length
    job: 'PATH={{ borg_virtual_env }}/bin:$PATH {{ borg_virtual_env }}/bin/borgmatic -c {{ borgmatic_config_dir }}/app_{{ item.name }}.yaml -v 2 >> /home/{{ borg_user }}/cron.log 2>&1'
  with_items:
    - '{{ borgmatic_configs }}'
  become: true
  become_user: '{{ borg_user }}'
